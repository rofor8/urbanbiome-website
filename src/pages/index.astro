---
// 1. Import the necessary functions and components
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import TeamGrid from '@/components/TeamGrid.astro';
import ContactForm from '@/components/ContactForm.astro';
import NetworkGrid from '@/components/NetworkGrid.astro';

// 2. Fetch all entries from the "sections" collection
const allSections = await getCollection('sections');

// 3. Sort the entries by the 'order' property in their frontmatter
allSections.sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

// Helper function to create a URL-friendly slug from a title
const slugify = (text: string) => text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

// Map of component names to actual components
const componentMap: Record<string, any> = {
  'TeamGrid': TeamGrid,
  'ContactForm': ContactForm,
  'NetworkGrid': NetworkGrid,
};
---

<BaseLayout title="UrbanBiome - Geospatial Analytics Software Platform">
	<header class="hero">
        <h1>We Enable Urban Rewilding</h1>
        <p class="hero-subtitle">Harnessing environmental intelligence, community insight, and local collaboration to guide green microinterventions where they’re needed most — with Bristol as our first living lab.</p>
    </header>

    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">
                <img src="/images/logo.svg" alt="UrbanBiome" class="logo-image" />
            </a>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links">
                <!-- Content sections navigation -->
                {allSections.map(section => {
                    const navText = section.data.navTitle || section.data.title;
                    return (
                        <li><a href={`#${slugify(section.data.title)}`}>{navText}</a></li>
                    )
                })}
            </ul>
        </div>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.querySelector('.mobile-menu-toggle');
            const navLinks = document.querySelector('.nav-links');

            toggle?.addEventListener('click', () => {
                navLinks?.classList.toggle('active');
                toggle?.classList.toggle('active');
            });

            // Close menu when clicking a link
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks?.classList.remove('active');
                    toggle?.classList.remove('active');
                });
            });
        });
    </script>

    <main>
        <!-- Loop through the sections again to create the content blocks -->
        {allSections.map(async (section) => {
            // Get the rendered <Content /> component for each section
            const { Content } = await section.render();
            const sectionId = slugify(section.data.title);
            // This line checks if 'centered: true' is in the frontmatter
            const contentClass = section.data.centered ? 'content-wrapper centered' : 'content-wrapper';

            // Check if this section should use a component
            const Component = section.data.useComponent ? componentMap[section.data.useComponent] : null;

            return (
                <section id={sectionId}>
                    <div class="container">
                        <div class="section-header">
                            <h2>{section.data.title}</h2>
                        </div>
                        {/* The 'centered' class is now added dynamically */}
                        <div class={contentClass}>
                             <!-- This renders the Markdown content -->
                            <Content />
                            <!-- If a component is specified, render it after the markdown -->
                            {Component && <Component />}
                        </div>
                    </div>
                </section>
            )
        })}
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>UrbanBiome Ltd</h4>
                    <p>Environmental intelligence platform</p>
                    <p>support@urbanbiome.co.uk</p>
                </div>
                <div class="footer-section">
                    <h4>Tools</h4>
                    <ul>
                        <li><a href="https://explorer.urbanbiome.co.uk/">Explorer</a></li>
                        <li><a href="https://sightings.urbanbiome.co.uk/">Sightings</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="/terms">Terms of Service</a></li>
                        <li><a href="/privacy">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 UrbanBiome Ltd. All rights reserved.</p>
            </div>
        </div>
    </footer>
</BaseLayout>
